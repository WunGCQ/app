define("RecordCtrl",["node","utils"],function(e,t,r){function o(e){var t=document.querySelector("#ueditor-container"),r=t.getBoundingClientRect(),o=UE.getEditor(e,{initialFrameWidth:r.width,initialFrameHeight:r.height-120,initialContent:t.getAttribute("data-placeholder")||"新闻内容"});return o.ready(function(){}),o}function n(e,t){this.conf=i.merge(a,t),this.recordStore=e,this.groups={},this.currentGroup="",this.currentRecord=null,this.$currentRecordNode=null}var c=e("node"),i=e("utils"),a={SELECTORS:{RECORDS_ARCHIVES_CONTAINER:"records-archives-container",RECORDS_ARCHIVE:"records-archive",RECORDS_ARCHIVE_TITLE:"records-archive__title",RECORDS_ARCHIVE_BODY:"records-archive__body",RECORD_LIST_ITEM:"record__list-item",RECORD_LIST_ITEM_ACTIVE:"record__list-item--active",RECROD_LIST_ITEM_STICKED:"record__list-item--sticked",RECROD_LIST_ITEM_PUBLISHED:"record__list-item--published",RECROD_LIST_ITEM_DRAFT:"record__list-item--draft",RECORD_DELETE_BTN:"record-delete-btn"}};n.prototype.makeRecordItemNode=function(e){var t=this.conf,r=c("<div>"),o=c("<h4>"),n=c("<h5>"),i=c("<span>");return i.addClass("fa fa-trash record-delete-btn"),r.addClass(t.SELECTORS.RECORD_LIST_ITEM),r.addClass(t.SELECTORS["RECROD_LIST_ITEM_"+e.status.toUpperCase()]),r.attr("data-id",e._id),o.text(e.title.length>20?e.title.slice(0,20)+"...":e.title),n.text(new Date(e.createdAt).toLocaleString()),r.append(o),r.append(n),r.append(i),r},n.prototype.makeRecordsArchiveNode=function(e){var t=this,r=this.conf,o=e.metas,n=e.list,a=c("<div>"),d=c("<h4>"),s=c("<div>");return a.addClass(r.SELECTORS.RECORDS_ARCHIVE),d.addClass(r.SELECTORS.RECORDS_ARCHIVE_TITLE),s.addClass(r.SELECTORS.RECORDS_ARCHIVE_BODY),d.text(o.hash),a.hash=o.hash,i.each(n,function(e){s.append(t.makeRecordItemNode(e))}),a.append(d),a.append(s),a.$body=s,a},n.prototype.updateGroup=function(e,t){var r=this,o=(this.conf,this.groups[e]),n=o.$container,c=i.archiveRecords(t),a=i.map(c,function(e){return r.makeRecordsArchiveNode(e)}),d=n.last();if(d&&a[0].hash===d.hash){a.shift()}return i.each(a,function(e){n.append(e)}),o.$archives=o.$archives||[],o.$archives=o.$archives.concat(a),n},n.prototype.isCurrentRecordModified=function(e){var t=this.currentRecord;return t?t.title!==s.val()||t.group!==p.val()||t.content!==E.getContent()||e&&t.status!==e.status:!1},n.prototype.insertRecord=function(e){console.log(e);var t,r=this.groups[e.group],o=i.makeDateMetas(e.createdAt),n=r.$archives&&r.$archives.length,c=null;if(n>0){for(var a=0;n>a;a++)if(t=r.$archives[a],t&&t.hash===o.hash){c=this.makeRecordItemNode(e),t.$body.prepend(c);break}}else t=this.makeRecordsArchiveNode(i.archiveRecords([e])[0]),c=t.$body.first(),r.$archives=[t].concat(r.$archive),r.$container.prepend(t);return c},n.prototype.setCurrentRecord=function(e,t){console.log(e),console.log(t);var r=this.conf;t=t||{},this.currentRecord=t,E.setContent(t.content),s.val(t.title),p.val(t.group),t._id&&(this.$currentRecordNode&&this.$currentRecordNode.removeClass(r.SELECTORS.RECORD_LIST_ITEM_ACTIVE),e&&(this.$currentRecordNode=e),this.$currentRecordNode.addClass(r.SELECTORS.RECORD_LIST_ITEM_ACTIVE),R.setStatus(t.status),E.execCommand("serverparam","_id",t._id))},n.prototype.removeRecordItemNode=function(e){e=e||this.$currentRecordNode,e&&e.remove()},n.prototype.switchToGroup=function(e){var t=this.conf,r=this.groups,o=r[e]=r[e]||{};this.currentGroup!==e&&(this.currentGroup=e,o.$container||(o.$container=c.one("<div>"),o.$container.addClass(t.SELECTORS.RECORDS_ARCHIVES_CONTAINE)),d.empty(),d.append(o.$container),0===o.$container.children().length&&this.fillGroup(e))},n.prototype.fillGroup=function(e){var t=this.recordStore,r=this.groups[e],o=this;t.getOnes(e).then(function(n){n&&n.length>0?o.updateGroup(e,t.getGroup(e)):r.status="empty",console.log(n)})},n.prototype.disableEditors=function(){},n.prototype.enableEditors=function(){},n.prototype.getModifiedRecordData=function(){var e,t,r,o=this.currentRecord,n=null;return o&&(n={},e=s.val(),t=p.val(),r=E.getContent(),r!==o.content&&(n.content=r),n.title=e,n.group=t,n._id=o._id,n.status=o.status),n},n.prototype.updateRecord=function(e){var t=this,r=this.recordStore;return t.currentRecord&&t.isCurrentRecordModified(e)?(e=e||{},e._id=e._id||t.currentRecord._id,t.disableEditors(),console.log(e),r.saveOne(e).then(function(e){return t.removeRecordItemNode(),t.setCurrentRecord(t.insertRecord(e),e),t.enableEditors(),e},function(e){return console.log(e),t.enableEditors(),e})):void 0},n.prototype.init=function(){var e=this,t=this.conf,r=this.recordStore;l.on("click",function(){if(n.currentRecord&&e.isCurrentRecordModified())confirm("modified. save?");else{var o=!0;t.beforeCreateOne&&(o=t.beforeCreateOne.call(e)),o&&r.createOne({group:e.currentGroup}).then(function(r){t.onCreateOneSucceed&&t.onCreateOneSucceed.call(e,r),e.insertRecord(r)},function(r){t.onCreateOneFailed&&t.onCreateOneFailed.call(e,r)})}}),d.delegate("click","."+t.SELECTORS.RECORD_LIST_ITEM,function(o){var n=c(o.currentTarget),i=n.attr("data-id"),a=c(o.target);a.hasClass(t.SELECTORS.RECORD_DELETE_BTN)?r.deleteOne(i).then(function(t){e.removeRecordItemNode(n)}):r.getOne(i).then(function(r){t.onGetOneSucceed&&t.onGetOneSucceed.call(e,r),e.setCurrentRecord(n,r)},function(r){t.onGetOneFailed&&t.onGetOneFailed.call(e,r)})}),h.on("change",function(t){var r=h.val();e.switchToGroup(r)}),u.on("click",function(t){var r=e.getModifiedRecordData();r&&(r.status="sticked"===r.status?r.status:"published",e.updateRecord(r))}),R.on("click",function(){var t=e.currentRecord;if(t){var r,o=t.status;"draft"===o?confirm("该文档未发布，置顶后将该为发布状态，确认继续?"):(R.setStatus("applying"),r=e.getModifiedRecordData(),r.status="sticked"===o?"published":"sticked",e.updateRecord(r).then(function(e){console.log("/// stick res"),console.log(e)}))}})};var d=n.$recordGroupsContainer=c.one("#records-group-container"),s=(n.$recordsLoaderIndicator=c.one("#records-loader-indicator"),n.$recordTitleInput=c.one("#record-title-input")),u=n.$recordPublishBtn=c.one("#record-publish-btn"),l=n.$recordCreateBtn=c.one("#record-create-btn"),R=(n.$recordSaveDraftBtn=c.one("#record-draft-btn"),n.$recordStickBtn=c.one("#record-stick-btn")),h=n.$recordsGroupSelector=c.one("#records-group-selector"),p=n.$recordsGroupSelector=c.one("#record-group-selector"),E=n.recordContentEditor=o("ueditor");return n.currentRecord=null,R.setStatus=function(){var e=R.attr("data-stick-text"),t=(R.attr("data-unstick-text"),R.attr("data-sticked-text"));return function(r){console.log(r),"applying"===r?i.disableEl(R):("sticked"===r?R.attr("data-enabled-text",t):R.attr("data-enabled-text",e),i.enableEl(R))}}(),n});