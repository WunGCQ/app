define("RecordCtrl",["node","utils"],function(e,t,r){function o(e){var t=document.querySelector("#ueditor-container"),r=t.getBoundingClientRect(),o=UE.getEditor(e,{initialFrameWidth:r.width,initialFrameHeight:r.height-98,initialContent:t.getAttribute("data-placeholder")||"新闻内容"});return o.ready(function(){n()}),o}function n(){d.each(S,function(e){e&&e.attr("disabled","disabled")}),_.setDisabled()}function i(){d.each(S,function(e){e&&e.removeAttr("disabled")}),_.setEnabled()}function c(e,t){this.conf=d.merge(s,t),this.recordStore=e,this.groups={},this.currentGroup="",this.currentRecord=null,this.$currentRecordNode=null}var a=e("node"),d=e("utils"),s={SELECTORS:{RECORDS_ARCHIVES_CONTAINER:"records-archives-container",RECORDS_ARCHIVE:"records-archive",RECORDS_ARCHIVE_TITLE:"records-archive__title",RECORDS_ARCHIVE_BODY_TOGGLE:"records-archive__toggle",RECORDS_ARCHIVE_BODY:"records-archive__body",RECORDS_ARCHIVE_ITEMS_COUNTER:"records-archive__items-counter",RECORD_LIST_ITEM:"record__list-item",RECORD_LIST_ITEM_ACTIVE:"record__list-item--active",RECROD_LIST_ITEM_STICKED:"record__list-item--sticked",RECROD_LIST_ITEM_PUBLISHED:"record__list-item--published",RECROD_LIST_ITEM_DRAFT:"record__list-item--draft",RECORD_DELETE_BTN:"record-delete-btn"}};c.prototype.makeRecordItemNode=function(e){var t=this.conf,r=a("<div>"),o=a("<h4>"),n=a("<h5>"),i=a("<span>"),c=d.makeDateMetas(e.createdAt);return i.addClass("fa fa-trash record-delete-btn"),r.addClass(t.SELECTORS.RECORD_LIST_ITEM),r.addClass(t.SELECTORS["RECROD_LIST_ITEM_"+e.status.toUpperCase()]),r.attr("data-id",e._id),r.attr("data-group",e.group),r.attr("data-hash",c.hash),o.text(e.title.length>20?e.title.slice(0,20)+"...":e.title),n.text(new Date(e.createdAt).toLocaleString()),r.append(o),r.append(n),r.append(i),r},c.prototype.makeRecordsArchiveNode=function(e){var t=this,r=this.conf,o=e.metas,n=e.list,i=a("<div>"),c=a("<h4>"),s=a("<span>"),u=a("<div>"),l=a("<span>");return s.addClass(r.SELECTORS.RECORDS_ARCHIVE_BODY_TOGGLE),i.addClass(r.SELECTORS.RECORDS_ARCHIVE),c.addClass(r.SELECTORS.RECORDS_ARCHIVE_TITLE),u.addClass(r.SELECTORS.RECORDS_ARCHIVE_BODY),c.text(o.hash),i.hash=o.hash,d.each(n,function(e){u.append(t.makeRecordItemNode(e))}),l.addClass(r.SELECTORS.RECORDS_ARCHIVE_ITEMS_COUNTER),l.text(n.length),c.append(l),i.append(c),i.append(u),i.$body=u,i.$itemsCounter=l,i},c.prototype.updateGroup=function(e,t){for(var r,o=this,n=(this.conf,this.groups[e]),i=n.$container,c=d.archiveRecords(t),a=n.$archives||[],s=d.map(c,function(e){return o.makeRecordsArchiveNode(e)}),u=a.length-1;u>=0;u--)if(r=a[u],r.hash===s[0].hash)for(var l,R=s.shift();l=R.$body.first();){var h=r.$itemsCounter.text();r.$itemsCounter.text(h++),r.$body.append(l)}return s&&s.length>0&&(d.each(s,function(e){i.append(e)}),console.log(s),n.$archives=a.concat(s)),i},c.prototype.isCurrentRecordModified=function(e){var t=this.currentRecord;return t?t.title!==l.val()||t.group!==f.val()||t.content!==_.getContent()||e&&t.status!==e.status:!1},c.prototype.getGroup=function(e){var t=this.conf,r=this.groups[e]=this.groups[e]||{};return r.$container||(r.$container=a.one("<div>"),r.$container.addClass(t.SELECTORS.RECORDS_ARCHIVES_CONTAINE)),r.$archives||(r.$archives=[]),r},c.prototype.insertRecord=function(e){console.log(e);var t,r=this.getGroup(e.group),o=d.makeDateMetas(e.createdAt),n=r.$archives&&r.$archives.length,i=null;if(n>0)for(var c=0;n>c;c++)if(t=r.$archives[c],t&&t.hash===o.hash){i=this.makeRecordItemNode(e),t.$itemsCounter.text(+t.$itemsCounter.text()+1),t.$body.prepend(i);break}return i||(t=this.makeRecordsArchiveNode(d.archiveRecords([e])[0]),i=t.$body.first(),r.$archives=[t].concat(r.$archives),r.$container.prepend(t)),i},c.prototype.setCurrentRecord=function(e,t){i();var r=this.conf;t=t||{},this.currentRecord=t,_.setContent(t.content),l.val(t.title),f.val(t.group),t._id&&(this.$currentRecordNode&&this.$currentRecordNode.removeClass(r.SELECTORS.RECORD_LIST_ITEM_ACTIVE),e&&(this.$currentRecordNode=e),this.$currentRecordNode.addClass(r.SELECTORS.RECORD_LIST_ITEM_ACTIVE),E.setStatus(t.status),_.execCommand("serverparam","_id",t._id))},c.prototype.removeRecordItemNode=function(e){var t,r,o,n,i;if(e=e||this.$currentRecordNode){t=this.groups[e.attr("data-group")].$archives,i=e.attr("data-hash");for(var c=t.length-1;c>=0;c--)if(t[c].hash===i){r=t[c],o=r.$itemsCounter,n=+o.text(),e.remove(),o.text(--n),0===n&&(t.splice(c,1),r.remove());break}}},c.prototype.switchToGroup=function(e){var t;this.currentGroup!==e&&(t=this.getGroup(e),this.currentGroup=e,u.empty(),u.append(t.$container),console.log(t),0===t.$container.children().length&&this.fillGroup(e))},c.prototype.fillGroup=function(e){var t=this.recordStore,r=this.getGroup(e),o=this;t.getOnes(e).then(function(n){console.log(n),n&&n.length>0?o.updateGroup(e,t.getGroup(e)):r.status="empty",console.log(n)})},c.prototype.disableEditors=function(){},c.prototype.enableEditors=function(){},c.prototype.getModifiedRecordData=function(){var e,t,r,o=this.currentRecord,n=null;return o&&(n={},e=l.val(),t=f.val(),r=_.getContent(),r!==o.content&&(n.content=r),n.title=e,n.group=t,n._id=o._id,n.status=o.status),n},c.prototype.updateRecord=function(e){var t=this,r=this.recordStore;return e=e||{},e._id=e._id||t.currentRecord._id,console.log(e),r.saveOne(e).then(function(e){return t.removeRecordItemNode(),t.setCurrentRecord(t.insertRecord(e),e),e},function(e){return console.log(e),t.enableEditors(),e})},c.prototype.init=function(){var e=this,t=this.conf,r=this.recordStore;h.on("click",function(){if(c.currentRecord&&e.isCurrentRecordModified())confirm("modified. save?");else{var o=!0;t.beforeCreateOne&&(o=t.beforeCreateOne.call(e)),o&&r.createOne({group:e.currentGroup}).then(function(r){t.onCreateOneSucceed&&t.onCreateOneSucceed.call(e,r),e.insertRecord(r)},function(r){t.onCreateOneFailed&&t.onCreateOneFailed.call(e,r)})}}),u.delegate("click","."+t.SELECTORS.RECORD_LIST_ITEM,function(o){var n=a(o.currentTarget),i=n.attr("data-id"),c=a(o.target);c.hasClass(t.SELECTORS.RECORD_DELETE_BTN)?r.deleteOne(i).then(function(t){e.removeRecordItemNode(n)}):r.getOne(i).then(function(r){t.onGetOneSucceed&&t.onGetOneSucceed.call(e,r),e.setCurrentRecord(n,r)},function(r){t.onGetOneFailed&&t.onGetOneFailed.call(e,r)})}),u.delegate("click","."+t.SELECTORS.RECORDS_ARCHIVE_TITLE,function(e){var t=a(e.currentTarget),r=t.next();r.slideToggle(.2)}),C.on("change",function(t){var r=C.val();e.switchToGroup(r)}),R.on("click",function(t){var r=e.getModifiedRecordData();r&&(r.status="sticked"===r.status?"sticked":"published",e.isCurrentRecordModified(r)&&(d.disableEl(R),e.updateRecord(r).then(function(e){d.enableEl(R)},function(e){d.enableEl(R)})))}),p.on("click",function(t){var r=e.getModifiedRecordData();r&&(r.status="draft",e.isCurrentRecordModified(r)&&(d.disableEl(p),e.updateRecord(r).then(function(e){d.enableEl(p)},function(e){d.enableEl(p)})))}),E.on("click",function(){var t=e.currentRecord;if(t){var r,o=t.status;"draft"===o?confirm("该文档未发布，置顶后将该为发布状态，确认继续?"):(E.setStatus("applying"),r=e.getModifiedRecordData(),r.status="sticked"===o?"published":"sticked",e.isCurrentRecordModified(r)&&e.updateRecord(r).then(function(e){console.log("/// stick res"),console.log(e)}))}})};var u=c.$recordGroupsContainer=a.one("#records-group-container"),l=(c.$recordsLoaderIndicator=a.one("#records-loader-indicator"),c.$recordTitleInput=a.one("#record-title-input")),R=c.$recordPublishBtn=a.one("#record-publish-btn"),h=c.$recordCreateBtn=a.one("#record-create-btn"),p=c.$recordSaveDraftBtn=a.one("#record-draft-btn"),E=c.$recordStickBtn=a.one("#record-stick-btn"),C=c.$recordsGroupSelector=a.one("#records-group-selector"),f=c.$recordsGroupSelector=a.one("#record-group-selector"),_=c.recordContentEditor=o("ueditor"),S=c.$$ctrls=[R,p,E,l,f];return c.currentRecord=null,E.setStatus=function(){var e=E.attr("data-stick-text"),t=(E.attr("data-unstick-text"),E.attr("data-sticked-text"));return function(r){"applying"===r?d.disableEl(E):(E.attr("data-enabled-text","sticked"===r?t:e),d.enableEl(E))}}(),c});