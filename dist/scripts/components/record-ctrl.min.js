define("RecordCtrl",["node","utils"],function(e,t,r){function o(e){var t=document.querySelector("#ueditor-container"),r=t.getBoundingClientRect(),o=UE.getEditor(e,{initialFrameWidth:r.width,initialFrameHeight:r.height-120,initialContent:t.getAttribute("data-placeholder")||"新闻内容"});return o.ready(function(){}),o}function n(e,t){this.conf=a.merge(c,t),this.recordStore=e,this.groups={},this.currentGroup="",this.currentRecord=null,this.$currentRecordNode=null}var i=e("node"),a=e("utils"),c={SELECTORS:{RECORDS_ARCHIVES_CONTAINER:"records-archives-container",RECORDS_ARCHIVE:"records-archive",RECORDS_ARCHIVE_TITLE:"records-archive__title",RECORDS_ARCHIVE_BODY_TOGGLE:"records-archive__toggle",RECORDS_ARCHIVE_BODY:"records-archive__body",RECORDS_ARCHIVE_ITEMS_COUNTER:"records-archive__items-counter",RECORD_LIST_ITEM:"record__list-item",RECORD_LIST_ITEM_ACTIVE:"record__list-item--active",RECROD_LIST_ITEM_STICKED:"record__list-item--sticked",RECROD_LIST_ITEM_PUBLISHED:"record__list-item--published",RECROD_LIST_ITEM_DRAFT:"record__list-item--draft",RECORD_DELETE_BTN:"record-delete-btn"}};n.prototype.makeRecordItemNode=function(e){var t=this.conf,r=i("<div>"),o=i("<h4>"),n=i("<h5>"),c=i("<span>"),d=a.makeDateMetas(e.createdAt);return c.addClass("fa fa-trash record-delete-btn"),r.addClass(t.SELECTORS.RECORD_LIST_ITEM),r.addClass(t.SELECTORS["RECROD_LIST_ITEM_"+e.status.toUpperCase()]),r.attr("data-id",e._id),r.attr("data-group",e.group),r.attr("data-hash",d.hash),o.text(e.title.length>20?e.title.slice(0,20)+"...":e.title),n.text(new Date(e.createdAt).toLocaleString()),r.append(o),r.append(n),r.append(c),r},n.prototype.makeRecordsArchiveNode=function(e){var t=this,r=this.conf,o=e.metas,n=e.list,c=i("<div>"),d=i("<h4>"),s=i("<span>"),u=i("<div>"),l=i("<span>");return s.addClass(r.SELECTORS.RECORDS_ARCHIVE_BODY_TOGGLE),c.addClass(r.SELECTORS.RECORDS_ARCHIVE),d.addClass(r.SELECTORS.RECORDS_ARCHIVE_TITLE),u.addClass(r.SELECTORS.RECORDS_ARCHIVE_BODY),d.text(o.hash),c.hash=o.hash,a.each(n,function(e){u.append(t.makeRecordItemNode(e))}),l.addClass(r.SELECTORS.RECORDS_ARCHIVE_ITEMS_COUNTER),l.text(n.length),d.append(l),c.append(d),c.append(u),c.$body=u,c.$itemsCounter=l,c},n.prototype.updateGroup=function(e,t){for(var r,o=this,n=(this.conf,this.groups[e]),i=n.$container,c=a.archiveRecords(t),d=n.$archives||[],s=a.map(c,function(e){return o.makeRecordsArchiveNode(e)}),u=d.length-1;u>=0;u--)if(r=d[u],r.hash===s[0].hash)for(var l,R=s.shift();l=R.$body.first();){var h=r.$itemsCounter.text();r.$itemsCounter.text(h++),r.$body.append(l)}return s&&s.length>0&&(a.each(s,function(e){i.append(e)}),console.log(s),n.$archives=d.concat(s)),i},n.prototype.isCurrentRecordModified=function(e){var t=this.currentRecord;return t?t.title!==s.val()||t.group!==p.val()||t.content!==C.getContent()||e&&t.status!==e.status:!1},n.prototype.insertRecord=function(e){console.log(e);var t=this.groups[e.group],r=a.makeDateMetas(e.createdAt);console.log(r);var o,n=t.$archives&&t.$archives.length,i=null;if(n>0)for(var c=0;n>c;c++)if(o=t.$archives[c],o&&o.hash===r.hash){i=this.makeRecordItemNode(e),o.$itemsCounter.text(+o.$itemsCounter.text()+1),o.$body.prepend(i);break}return i||(o=this.makeRecordsArchiveNode(a.archiveRecords([e])[0]),i=o.$body.first(),t.$archives=[o].concat(t.$archives),t.$container.prepend(o)),i},n.prototype.setCurrentRecord=function(e,t){console.log(e),console.log(t);var r=this.conf;t=t||{},this.currentRecord=t,C.setContent(t.content),s.val(t.title),p.val(t.group),t._id&&(this.$currentRecordNode&&this.$currentRecordNode.removeClass(r.SELECTORS.RECORD_LIST_ITEM_ACTIVE),e&&(this.$currentRecordNode=e),this.$currentRecordNode.addClass(r.SELECTORS.RECORD_LIST_ITEM_ACTIVE),h.setStatus(t.status),C.execCommand("serverparam","_id",t._id))},n.prototype.removeRecordItemNode=function(e){var t,r,o,n,i;if(e=e||this.$currentRecordNode){t=this.groups[e.attr("data-group")].$archives,i=e.attr("data-hash");for(var a=t.length-1;a>=0;a--)if(t[a].hash===i){r=t[a],o=r.$itemsCounter,n=+o.text(),e.remove(),o.text(--n),0===n&&(t.splice(a,1),r.remove());break}}},n.prototype.switchToGroup=function(e){var t=this.conf,r=this.groups,o=r[e]=r[e]||{};this.currentGroup!==e&&(this.currentGroup=e,o.$container||(o.$container=i.one("<div>"),o.$container.addClass(t.SELECTORS.RECORDS_ARCHIVES_CONTAINE)),d.empty(),d.append(o.$container),0===o.$container.children().length&&this.fillGroup(e))},n.prototype.fillGroup=function(e){var t=this.recordStore,r=this.groups[e],o=this;t.getOnes(e).then(function(n){n&&n.length>0?o.updateGroup(e,t.getGroup(e)):r.status="empty",console.log(n)})},n.prototype.disableEditors=function(){},n.prototype.enableEditors=function(){},n.prototype.getModifiedRecordData=function(){var e,t,r,o=this.currentRecord,n=null;return o&&(n={},e=s.val(),t=p.val(),r=C.getContent(),r!==o.content&&(n.content=r),n.title=e,n.group=t,n._id=o._id,n.status=o.status),n},n.prototype.updateRecord=function(e){var t=this,r=this.recordStore;return e=e||{},e._id=e._id||t.currentRecord._id,console.log(e),r.saveOne(e).then(function(e){return t.removeRecordItemNode(),t.setCurrentRecord(t.insertRecord(e),e),e},function(e){return console.log(e),t.enableEditors(),e})},n.prototype.init=function(){var e=this,t=this.conf,r=this.recordStore;l.on("click",function(){if(n.currentRecord&&e.isCurrentRecordModified())confirm("modified. save?");else{var o=!0;t.beforeCreateOne&&(o=t.beforeCreateOne.call(e)),o&&r.createOne({group:e.currentGroup}).then(function(r){t.onCreateOneSucceed&&t.onCreateOneSucceed.call(e,r),e.insertRecord(r)},function(r){t.onCreateOneFailed&&t.onCreateOneFailed.call(e,r)})}}),d.delegate("click","."+t.SELECTORS.RECORD_LIST_ITEM,function(o){var n=i(o.currentTarget),a=n.attr("data-id"),c=i(o.target);c.hasClass(t.SELECTORS.RECORD_DELETE_BTN)?r.deleteOne(a).then(function(t){e.removeRecordItemNode(n)}):r.getOne(a).then(function(r){t.onGetOneSucceed&&t.onGetOneSucceed.call(e,r),e.setCurrentRecord(n,r)},function(r){t.onGetOneFailed&&t.onGetOneFailed.call(e,r)})}),d.delegate("click","."+t.SELECTORS.RECORDS_ARCHIVE_TITLE,function(e){var t=i(e.currentTarget),r=t.next();r.slideToggle(.2)}),E.on("change",function(t){var r=E.val();e.switchToGroup(r)}),u.on("click",function(t){var r=e.getModifiedRecordData();r&&(r.status="sticked"===r.status?"sticked":"published",e.isCurrentRecordModified(r)&&(a.disableEl(u),e.updateRecord(r).then(function(e){a.enableEl(u)},function(e){a.enableEl(u)})))}),R.on("click",function(t){var r=e.getModifiedRecordData();r&&(r.status="draft",e.isCurrentRecordModified(r)&&(a.disableEl(R),e.updateRecord(r).then(function(e){a.enableEl(R)},function(e){a.enableEl(R)})))}),h.on("click",function(){var t=e.currentRecord;if(t){var r,o=t.status;"draft"===o?confirm("该文档未发布，置顶后将该为发布状态，确认继续?"):(h.setStatus("applying"),r=e.getModifiedRecordData(),r.status="sticked"===o?"published":"sticked",e.isCurrentRecordModified(r)&&e.updateRecord(r).then(function(e){console.log("/// stick res"),console.log(e)}))}})};var d=n.$recordGroupsContainer=i.one("#records-group-container"),s=(n.$recordsLoaderIndicator=i.one("#records-loader-indicator"),n.$recordTitleInput=i.one("#record-title-input")),u=n.$recordPublishBtn=i.one("#record-publish-btn"),l=n.$recordCreateBtn=i.one("#record-create-btn"),R=n.$recordSaveDraftBtn=i.one("#record-draft-btn"),h=n.$recordStickBtn=i.one("#record-stick-btn"),E=n.$recordsGroupSelector=i.one("#records-group-selector"),p=n.$recordsGroupSelector=i.one("#record-group-selector"),C=n.recordContentEditor=o("ueditor");return n.currentRecord=null,h.setStatus=function(){var e=h.attr("data-stick-text"),t=(h.attr("data-unstick-text"),h.attr("data-sticked-text"));return function(r){console.log(r),"applying"===r?a.disableEl(h):("sticked"===r?h.attr("data-enabled-text",t):h.attr("data-enabled-text",e),a.enableEl(h))}}(),n});