define("RecordCtrl",["node","utils"],function(e,t,r){function o(e){var t=document.querySelector("#ueditor-container"),r=t.getBoundingClientRect(),o=UE.getEditor(e,{initialFrameWidth:r.width,initialFrameHeight:r.height-120,initialContent:t.getAttribute("data-placeholder")||"新闻内容"});return o.ready(function(){}),o}function n(e,t){this.conf=i.merge(a,t),this.recordStore=e,this.groups={},this.currentGroup="",this.currentRecord=null,this.$currentRecordNode=null}var c=e("node"),i=e("utils"),a={SELECTORS:{RECORDS_ARCHIVES_CONTAINER:"records-archives-container",RECORDS_ARCHIVE:"records-archive",RECORDS_ARCHIVE_TITLE:"records-archive__title",RECORDS_ARCHIVE_BODY_TOGGLE:"records-archive__toggle",RECORDS_ARCHIVE_BODY:"records-archive__body",RECORD_LIST_ITEM:"record__list-item",RECORD_LIST_ITEM_ACTIVE:"record__list-item--active",RECROD_LIST_ITEM_STICKED:"record__list-item--sticked",RECROD_LIST_ITEM_PUBLISHED:"record__list-item--published",RECROD_LIST_ITEM_DRAFT:"record__list-item--draft",RECORD_DELETE_BTN:"record-delete-btn"}};n.prototype.makeRecordItemNode=function(e){var t=this.conf,r=c("<div>"),o=c("<h4>"),n=c("<h5>"),i=c("<span>");return i.addClass("fa fa-trash record-delete-btn"),r.addClass(t.SELECTORS.RECORD_LIST_ITEM),r.addClass(t.SELECTORS["RECROD_LIST_ITEM_"+e.status.toUpperCase()]),r.attr("data-id",e._id),o.text(e.title.length>20?e.title.slice(0,20)+"...":e.title),n.text(new Date(e.createdAt).toLocaleString()),r.append(o),r.append(n),r.append(i),r},n.prototype.makeRecordsArchiveNode=function(e){var t=this,r=this.conf,o=e.metas,n=e.list,a=c("<div>"),d=c("<h4>"),s=c("<span>"),u=c("<div>");return s.addClass(r.SELECTORS.RECORDS_ARCHIVE_BODY_TOGGLE),console.log(d),a.addClass(r.SELECTORS.RECORDS_ARCHIVE),d.addClass(r.SELECTORS.RECORDS_ARCHIVE_TITLE),u.addClass(r.SELECTORS.RECORDS_ARCHIVE_BODY),d.text(o.hash),a.hash=o.hash,i.each(n,function(e){u.append(t.makeRecordItemNode(e))}),d.append(s),a.append(d),a.append(u),a.$body=u,a},n.prototype.updateGroup=function(e,t){var r=this,o=(this.conf,this.groups[e]),n=o.$container,c=i.archiveRecords(t);console.log(c);var a=i.map(c,function(e){return r.makeRecordsArchiveNode(e)}),d=n.last();if(d&&a[0].hash===d.hash)for(var s,u=a.shift();s=u.$body.first();)d.$body.append(s);return i.each(a,function(e){n.append(e)}),o.$archives=o.$archives||[],o.$archives=o.$archives.concat(a),n},n.prototype.isCurrentRecordModified=function(e){var t=this.currentRecord;return t?t.title!==s.val()||t.group!==E.val()||t.content!==C.getContent()||e&&t.status!==e.status:!1},n.prototype.insertRecord=function(e){console.log(e);var t=this.groups[e.group],r=i.makeDateMetas(e.createdAt);console.log(r);var o,n=t.$archives&&t.$archives.length,c=null;if(n>0)for(var a=0;n>a;a++)if(o=t.$archives[a],o&&o.hash===r.hash){c=this.makeRecordItemNode(e),o.$body.prepend(c);break}return c||(o=this.makeRecordsArchiveNode(i.archiveRecords([e])[0]),c=o.$body.first(),t.$archives=[o].concat(t.$archive),t.$container.prepend(o)),c},n.prototype.setCurrentRecord=function(e,t){console.log(e),console.log(t);var r=this.conf;t=t||{},this.currentRecord=t,C.setContent(t.content),s.val(t.title),E.val(t.group),t._id&&(this.$currentRecordNode&&this.$currentRecordNode.removeClass(r.SELECTORS.RECORD_LIST_ITEM_ACTIVE),e&&(this.$currentRecordNode=e),this.$currentRecordNode.addClass(r.SELECTORS.RECORD_LIST_ITEM_ACTIVE),h.setStatus(t.status),C.execCommand("serverparam","_id",t._id))},n.prototype.removeRecordItemNode=function(e){e=e||this.$currentRecordNode,e&&e.remove()},n.prototype.switchToGroup=function(e){var t=this.conf,r=this.groups,o=r[e]=r[e]||{};this.currentGroup!==e&&(this.currentGroup=e,o.$container||(o.$container=c.one("<div>"),o.$container.addClass(t.SELECTORS.RECORDS_ARCHIVES_CONTAINE)),d.empty(),d.append(o.$container),0===o.$container.children().length&&this.fillGroup(e))},n.prototype.fillGroup=function(e){var t=this.recordStore,r=this.groups[e],o=this;t.getOnes(e).then(function(n){n&&n.length>0?o.updateGroup(e,t.getGroup(e)):r.status="empty",console.log(n)})},n.prototype.disableEditors=function(){},n.prototype.enableEditors=function(){},n.prototype.getModifiedRecordData=function(){var e,t,r,o=this.currentRecord,n=null;return o&&(n={},e=s.val(),t=E.val(),r=C.getContent(),r!==o.content&&(n.content=r),n.title=e,n.group=t,n._id=o._id,n.status=o.status),n},n.prototype.updateRecord=function(e){var t=this,r=this.recordStore;return e=e||{},e._id=e._id||t.currentRecord._id,console.log(e),r.saveOne(e).then(function(e){return t.removeRecordItemNode(),t.setCurrentRecord(t.insertRecord(e),e),e},function(e){return console.log(e),t.enableEditors(),e})},n.prototype.init=function(){var e=this,t=this.conf,r=this.recordStore;l.on("click",function(){if(n.currentRecord&&e.isCurrentRecordModified())confirm("modified. save?");else{var o=!0;t.beforeCreateOne&&(o=t.beforeCreateOne.call(e)),o&&r.createOne({group:e.currentGroup}).then(function(r){t.onCreateOneSucceed&&t.onCreateOneSucceed.call(e,r),e.insertRecord(r)},function(r){t.onCreateOneFailed&&t.onCreateOneFailed.call(e,r)})}}),d.delegate("click","."+t.SELECTORS.RECORD_LIST_ITEM,function(o){var n=c(o.currentTarget),i=n.attr("data-id"),a=c(o.target);a.hasClass(t.SELECTORS.RECORD_DELETE_BTN)?r.deleteOne(i).then(function(t){e.removeRecordItemNode(n)}):r.getOne(i).then(function(r){t.onGetOneSucceed&&t.onGetOneSucceed.call(e,r),e.setCurrentRecord(n,r)},function(r){t.onGetOneFailed&&t.onGetOneFailed.call(e,r)})}),d.delegate("click","."+t.SELECTORS.RECORDS_ARCHIVE_TITLE,function(e){var t=c(e.currentTarget),r=t.next();r.slideToggle(.2)}),p.on("change",function(t){var r=p.val();e.switchToGroup(r)}),u.on("click",function(t){var r=e.getModifiedRecordData();r&&(r.status="sticked"===r.status?"sticked":"published",e.isCurrentRecordModified(r)&&(i.disableEl(u),e.updateRecord(r).then(function(e){i.enableEl(u)},function(e){i.enableEl(u)})))}),R.on("click",function(t){var r=e.getModifiedRecordData();r&&(r.status="draft",e.isCurrentRecordModified(r)&&(i.disableEl(R),e.updateRecord(r).then(function(e){i.enableEl(R)},function(e){i.enableEl(R)})))}),h.on("click",function(){var t=e.currentRecord;if(t){var r,o=t.status;"draft"===o?confirm("该文档未发布，置顶后将该为发布状态，确认继续?"):(h.setStatus("applying"),r=e.getModifiedRecordData(),r.status="sticked"===o?"published":"sticked",e.isCurrentRecordModified(r)&&e.updateRecord(r).then(function(e){console.log("/// stick res"),console.log(e)}))}})};var d=n.$recordGroupsContainer=c.one("#records-group-container"),s=(n.$recordsLoaderIndicator=c.one("#records-loader-indicator"),n.$recordTitleInput=c.one("#record-title-input")),u=n.$recordPublishBtn=c.one("#record-publish-btn"),l=n.$recordCreateBtn=c.one("#record-create-btn"),R=n.$recordSaveDraftBtn=c.one("#record-draft-btn"),h=n.$recordStickBtn=c.one("#record-stick-btn"),p=n.$recordsGroupSelector=c.one("#records-group-selector"),E=n.$recordsGroupSelector=c.one("#record-group-selector"),C=n.recordContentEditor=o("ueditor");return n.currentRecord=null,h.setStatus=function(){var e=h.attr("data-stick-text"),t=(h.attr("data-unstick-text"),h.attr("data-sticked-text"));return function(r){console.log(r),"applying"===r?i.disableEl(h):("sticked"===r?h.attr("data-enabled-text",t):h.attr("data-enabled-text",e),i.enableEl(h))}}(),n});