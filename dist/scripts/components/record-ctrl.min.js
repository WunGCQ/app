define("RecordCtrl",["node","utils"],function(e,t,r){function o(e){var t=document.querySelector("#ueditor-container"),r=t.getBoundingClientRect(),o=UE.getEditor(e,{initialFrameWidth:r.width,initialFrameHeight:r.height-120,initialContent:t.getAttribute("data-placeholder")||"新闻内容"});return o.ready(function(){}),o}function n(e,t){this.conf=i.merge(a,t),this.recordStore=e,this.groups={},this.currentGroup="",this.currentRecord=null,this.$currentRecordNode=null}var c=e("node"),i=e("utils"),a={SELECTORS:{RECORDS_ARCHIVES_CONTAINER:"records-archives-container",RECORDS_ARCHIVE:"records-archive",RECORDS_ARCHIVE_TITLE:"records-archive__title",RECORDS_ARCHIVE_BODY:"records-archive__body",RECORD_LIST_ITEM:"record__list-item",RECORD_LIST_ITEM_ACTIVE:"record__list-item--active",RECORD_DELETE_BTN:"record-delete-btn"}};n.prototype.makeRecordItemNode=function(e){var t=this.conf,r=c("<div>"),o=c("<h4>"),n=c("<h5>"),i=c("<span>");return i.addClass("fa fa-trash float--right record-delete-btn"),r.addClass(t.SELECTORS.RECORD_LIST_ITEM),r.attr("data-id",e._id),o.text(e.title),n.text(new Date(e.createdAt).toLocaleString()),r.append(i),r.append(o),r.append(n),r},n.prototype.makeRecordsArchiveNode=function(e){var t=this,r=this.conf,o=e.metas,n=e.list,a=c("<div>"),d=c("<h4>"),s=c("<div>");return a.addClass(r.SELECTORS.RECORDS_ARCHIVE),d.addClass(r.SELECTORS.RECORDS_ARCHIVE_TITLE),s.addClass(r.SELECTORS.RECORDS_ARCHIVE_BODY),d.text(o.hash),a.hash=o.hash,i.each(n,function(e){s.append(t.makeRecordItemNode(e))}),a.append(d),a.append(s),a.$body=s,a},n.prototype.updateGroup=function(e,t){var r=this,o=(this.conf,this.groups[e]),n=o.$container,c=i.archiveRecords(t),a=i.map(c,function(e){return r.makeRecordsArchiveNode(e)}),d=n.last();if(d&&a[0].hash===d.hash){a.shift()}return i.each(a,function(e){n.append(e)}),o.$archives=o.$archives||[],o.$archives=o.$archives.concat(a),n},n.prototype.isCurrentRecordModified=function(){var e=this.currentRecord;return e?e.title!==s.val()||e.group!==R.val()||e.content!==p.getContent():!1},n.prototype.insertRecord=function(e){console.log(e);var t=this.groups[e.group],r=i.makeDateMetas(e.createdAt),o=t.$archives&&t.$archives[0];o&&o.hash===r.hash?o.$body.prepend(this.makeRecordItemNode(e)):(o=this.makeRecordsArchiveNode(i.archiveRecords([e])[0]),t.$archives=[o].concat(t.$archive),t.$container.prepend(o))},n.prototype.setCurrentRecord=function(e,t){var r=this.conf;t=t||{},this.currentRecord=t,p.setContent(t.content),s.val(t.title),R.val(t.group),t._id&&(this.$currentRecordNode&&this.$currentRecordNode.removeClass(r.SELECTORS.RECORD_LIST_ITEM_ACTIVE),e&&(this.$currentRecordNode=e),this.$currentRecordNode.addClass(r.SELECTORS.RECORD_LIST_ITEM_ACTIVE),p.execCommand("serverparam","_id",t._id))},n.prototype.removeRecordItemNode=function(e){e.remove()},n.prototype.switchToGroup=function(e){var t=this.conf,r=this.groups,o=r[e]=r[e]||{};this.currentGroup!==e&&(this.currentGroup=e,o.$container||(o.$container=c.one("<div>"),o.$container.addClass(t.SELECTORS.RECORDS_ARCHIVES_CONTAINE)),d.empty(),d.append(o.$container),0===o.$container.children().length&&this.fillGroup(e))},n.prototype.fillGroup=function(e){var t=this.recordStore,r=this.groups[e],o=this;t.getOnes(e).then(function(n){n&&n.length>0?o.updateGroup(e,t.getGroup(e)):r.status="empty",console.log(n)})},n.prototype.init=function(){var e=this,t=this.conf,r=this.recordStore;l.on("click",function(){if(n.currentRecord&&e.isCurrentRecordModified())confirm("modified. save?");else{var o=!0;t.beforeCreateOne&&(o=t.beforeCreateOne.call(e)),o&&r.createOne({group:e.currentGroup}).then(function(r){t.onCreateOneSucceed&&t.onCreateOneSucceed.call(e,r),e.insertRecord(r)},function(r){t.onCreateOneFailed&&t.onCreateOneFailed.call(e,r)})}}),d.delegate("click","."+t.SELECTORS.RECORD_LIST_ITEM,function(o){var n=c(o.currentTarget),i=n.attr("data-id"),a=c(o.target);a.hasClass(t.SELECTORS.RECORD_DELETE_BTN)?r.deleteOne(i).then(function(t){e.removeRecordItemNode(n)}):r.getOne(i).then(function(r){t.onGetOneSucceed&&t.onGetOneSucceed.call(e,r),e.setCurrentRecord(n,r)},function(r){t.onGetOneFailed&&t.onGetOneFailed.call(e,r)})}),h.on("change",function(t){var r=h.val();e.switchToGroup(r)}),u.on("click",function(t){if(e.currentRecord&&e.isCurrentRecordModified()){var o=r.copyOne(e.currentRecord);o.content=p.getContent(),o.title=s.val(),o.group=R.val(),delete o.attachments,delete o.images,i.disableEl(u),r.saveOne(o).then(function(t){e.setCurrentRecord(null,t),i.enableEl(u)},function(e){console.log(e),i.enableEl(u)})}})};var d=n.$recordGroupsContainer=c.one("#records-group-container"),s=(n.$recordsLoaderIndicator=c.one("#records-loader-indicator"),n.$recordTitleInput=c.one("#record-title-input")),u=n.$recordPublishBtn=c.one("#record-publish-btn"),l=n.$recordCreateBtn=c.one("#record-create-btn"),h=n.$recordsGroupSelector=c.one("#records-group-selector"),R=n.$recordsGroupSelector=c.one("#record-group-selector"),p=(n.$recordSaveDraftBtn=c.one("#record-draft-btn"),n.recordContentEditor=o("ueditor"));return n.currentRecord=null,n});