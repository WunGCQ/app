define("RecordCtrl",["node","utils"],function(e,t,r){function o(e){var t=document.querySelector("#ueditor-container"),r=t.getBoundingClientRect(),o=UE.getEditor(e,{initialFrameWidth:r.width,initialFrameHeight:r.height-98,initialContent:t.getAttribute("data-placeholder")||"新闻内容"});return o.ready(function(){n(),o.addListener("contentChange",function(e){S++,console.log(S)})}),o}function n(){s.each(v,function(e){e&&e.attr("disabled","disabled")}),g.setDisabled()}function c(){s.each(v,function(e){e&&e.removeAttr("disabled")}),g.setEnabled()}function i(){h.val(""),g.setContent("")}function a(e,t){this.conf=s.merge(u,t),this.recordStore=e,this.groups={},this.currentGroup="",this.currentRecord=null,this.$currentRecordNode=null}var d=e("node"),s=e("utils"),u={SELECTORS:{RECORDS_ARCHIVES_CONTAINER:"records-archives-container",RECORDS_ARCHIVE:"records-archive",RECORDS_ARCHIVE_TITLE:"records-archive__title",RECORDS_ARCHIVE_BODY_TOGGLE:"records-archive__toggle",RECORDS_ARCHIVE_BODY:"records-archive__body",RECORDS_ARCHIVE_ITEMS_COUNTER:"records-archive__items-counter",RECORD_LIST_ITEM:"record__list-item",RECORD_LIST_ITEM_ACTIVE:"record__list-item--active",RECORD_LIST_ITEM_STICKED:"record__list-item--sticked",RECORD_LIST_ITEM_PUBLISHED:"record__list-item--published",RECORD_LIST_ITEM_DRAFT:"record__list-item--draft",RECORD_DELETE_BTN:"record-delete-btn"}};a.prototype.makeRecordItemNode=function(e){var t=this.conf,r=d("<div>"),o=d("<h4>"),n=d("<h5>"),c=d("<span>"),i=s.makeDateMetas(e.createdAt);return c.addClass("fa fa-trash record-delete-btn"),r.addClass(t.SELECTORS.RECORD_LIST_ITEM),r.addClass(t.SELECTORS["RECORD_LIST_ITEM_"+e.status.toUpperCase()]),r.attr("data-id",e._id),r.attr("data-group",e.group),r.attr("data-hash",i.hash),o.text(e.title.length>20?e.title.slice(0,20)+"...":e.title),n.text(new Date(e.createdAt).toLocaleString()),r.append(o),r.append(n),r.append(c),r},a.prototype.makeRecordsArchiveNode=function(e){var t=this,r=this.conf,o=e.metas,n=e.list,c=d("<div>"),i=d("<h4>"),a=d("<span>"),u=d("<div>"),l=d("<span>");return a.addClass(r.SELECTORS.RECORDS_ARCHIVE_BODY_TOGGLE),c.addClass(r.SELECTORS.RECORDS_ARCHIVE),i.addClass(r.SELECTORS.RECORDS_ARCHIVE_TITLE),u.addClass(r.SELECTORS.RECORDS_ARCHIVE_BODY),i.text(o.hash),c.hash=o.hash,s.each(n,function(e){u.append(t.makeRecordItemNode(e))}),l.addClass(r.SELECTORS.RECORDS_ARCHIVE_ITEMS_COUNTER),l.text(n.length),i.append(l),c.append(i),c.append(u),c.$body=u,c.$itemsCounter=l,c},a.prototype.updateGroup=function(e,t){for(var r,o=this,n=(this.conf,this.groups[e]),c=n.$container,i=s.archiveRecords(t),a=n.$archives||[],d=s.map(i,function(e){return o.makeRecordsArchiveNode(e)}),u=a.length-1;u>=0;u--)if(r=a[u],r.hash===d[0].hash)for(var l,h=d.shift();l=h.$body.first();){var R=r.$itemsCounter.text();r.$itemsCounter.text(R++),r.$body.append(l)}return d&&d.length>0&&(s.each(d,function(e){c.append(e)}),console.log(d),n.$archives=a.concat(d)),c},a.prototype.isCurrentRecordModified=function(e){var t=this.currentRecord||e;return t?t.title!==h.val()||t.group!==_.val()||e&&t.status!==e.status||S>0:!1},a.prototype.getGroup=function(e){var t=this.conf,r=this.groups[e]=this.groups[e]||{};return r.$container||(r.$container=d.one("<div>"),r.$container.addClass(t.SELECTORS.RECORDS_ARCHIVES_CONTAINE)),r.$archives||(r.$archives=[]),r},a.prototype.insertRecord=function(e){console.log(e);var t,r=this.getGroup(e.group),o=s.makeDateMetas(e.createdAt),n=r.$archives&&r.$archives.length,c=null;if(n>0)for(var i=0;n>i;i++)if(t=r.$archives[i],t&&t.hash===o.hash){c=this.makeRecordItemNode(e),t.$itemsCounter.text(+t.$itemsCounter.text()+1),t.$body.prepend(c);break}return c||(t=this.makeRecordsArchiveNode(s.archiveRecords([e])[0]),c=t.$body.first(),r.$archives=[t].concat(r.$archives),r.$container.prepend(t)),c},a.prototype.setCurrentRecord=function(e,t){c();var r=this.conf;t=t||{},this.currentRecord=t,h.val(t.title),_.val(t.group),t._id&&(this.$currentRecordNode&&this.$currentRecordNode.removeClass(r.SELECTORS.RECORD_LIST_ITEM_ACTIVE),e&&(this.$currentRecordNode=e),this.$currentRecordNode.addClass(r.SELECTORS.RECORD_LIST_ITEM_ACTIVE),C.setStatus(t.status),g.execCommand("serverparam","_id",t._id)),S=-1,g.setContent(t.content)},a.prototype.removeRecordItemNode=function(e){var t,r,o,c,a;if(e=e||this.$currentRecordNode){t=this.groups[e.attr("data-group")].$archives,a=e.attr("data-hash");for(var d=t.length-1;d>=0;d--)if(t[d].hash===a){r=t[d],o=r.$itemsCounter,c=+o.text(),e.remove(),this.currentRecord&&this.currentRecord._id===e.attr("data-id")&&(this.currentRecord=null,this.$currentRecordNode=null,i(),n()),o.text(--c),0===c&&(t.splice(d,1),r.remove());break}}},a.prototype.switchToGroup=function(e){var t;this.currentGroup!==e&&(t=this.getGroup(e),this.currentGroup=e,l.empty(),l.append(t.$container),console.log(t),0===t.$container.children().length&&this.fillGroup(e))},a.prototype.fillGroup=function(e){var t=this.recordStore,r=this.getGroup(e),o=this;t.getOnes(e).then(function(n){console.log(n),n&&n.length>0?o.updateGroup(e,t.getGroup(e)):r.status="empty",console.log(n)})},a.prototype.disableEditors=function(){},a.prototype.enableEditors=function(){},a.prototype.getImagesFromRecord=function(e){var t=[];e=e||this.currentRecord,e=e&&e.content||e;var r=d(e);if(console.log(r),r.html()){var o=r.all("img");o.each(function(e){t.push(e.attr("src"))}),console.log(t)}return t},a.prototype.getAttachmentsFromRecord=function(e){var t=[];return e=e||this.currentRecord,e=e&&e.content||e,console.log(e),t},a.prototype.getModifiedRecordData=function(){var e,t,r=this.currentRecord,o=null;return r&&(o={},o._id=r._id,e=h.val(),t=_.val(),e!==r.title&&(o.title=e),t!==r.group&&(o.group=t),S>0&&(o.content=g.getContent(),o.images=this.getImagesFromRecord(o),o.attachments=this.getAttachmentsFromRecord(o)),o.status=r.status),o},a.prototype.updateRecord=function(e){var t=this,r=this.recordStore;return e&&e._id?(console.log(e),r.saveOne(e).then(function(e){return t.removeRecordItemNode(),t.setCurrentRecord(t.insertRecord(e),e),e},function(e){return console.log(e),t.enableEditors(),e})):void 0},a.prototype.init=function(){var e=this,t=this.conf,r=this.recordStore;p.on("click",function(){if(a.currentRecord&&e.isCurrentRecordModified())confirm("modified. save?");else{var o=!0;t.beforeCreateOne&&(o=t.beforeCreateOne.call(e)),o&&r.createOne({group:e.currentGroup}).then(function(r){t.onCreateOneSucceed&&t.onCreateOneSucceed.call(e,r),e.insertRecord(r)},function(r){t.onCreateOneFailed&&t.onCreateOneFailed.call(e,r)})}}),l.delegate("click","."+t.SELECTORS.RECORD_LIST_ITEM,function(o){var n=d(o.currentTarget),c=n.attr("data-id"),i=d(o.target);i.hasClass(t.SELECTORS.RECORD_DELETE_BTN)?r.deleteOne(c).then(function(t){e.removeRecordItemNode(n)}):r.getOne(c).then(function(r){t.onGetOneSucceed&&t.onGetOneSucceed.call(e,r),e.setCurrentRecord(n,r)},function(r){t.onGetOneFailed&&t.onGetOneFailed.call(e,r)})}),l.delegate("click","."+t.SELECTORS.RECORDS_ARCHIVE_TITLE,function(e){var t=d(e.currentTarget),r=t.next();r.slideToggle(.2)}),f.on("change",function(t){var r=f.val();e.switchToGroup(r)}),R.on("click",function(t){var r=e.getModifiedRecordData();r&&(r.status="sticked"===r.status?"sticked":"published",s.keys(r).length>2&&(s.disableEl(R),e.updateRecord(r).then(function(t){console.log(t),s.enableEl(R),e.currentRecord=t,S=0},function(e){s.enableEl(R)})))}),E.on("click",function(t){var r=e.getModifiedRecordData();r&&(r.status="draft",e.isCurrentRecordModified(r)&&(s.disableEl(E),e.updateRecord(r).then(function(e){s.enableEl(E)},function(e){s.enableEl(E)})))}),C.on("click",function(){var t=e.currentRecord;if(t){var r,o=t.status;"draft"===o?confirm("该文档未发布，置顶后将该为发布状态，确认继续?"):(C.setStatus("applying"),r=e.getModifiedRecordData(),r.status="sticked"===o?"published":"sticked",e.isCurrentRecordModified(r)&&e.updateRecord(r).then(function(e){console.log("/// stick res"),console.log(e)}))}})};var l=a.$recordGroupsContainer=d.one("#records-group-container"),h=(a.$recordsLoaderIndicator=d.one("#records-loader-indicator"),a.$recordTitleInput=d.one("#record-title-input")),R=a.$recordPublishBtn=d.one("#record-publish-btn"),p=a.$recordCreateBtn=d.one("#record-create-btn"),E=a.$recordSaveDraftBtn=d.one("#record-draft-btn"),C=a.$recordStickBtn=d.one("#record-stick-btn"),f=a.$recordsGroupSelector=d.one("#records-group-selector"),_=a.$recordsGroupSelector=d.one("#record-group-selector"),g=a.recordContentEditor=o("ueditor"),v=a.$$ctrls=[R,E,C,h,_],S=-1;return a.currentRecord=null,C.setStatus=function(){var e=C.attr("data-stick-text"),t=(C.attr("data-unstick-text"),C.attr("data-sticked-text"));return function(r){"applying"===r?s.disableEl(C):(C.attr("data-enabled-text","sticked"===r?t:e),s.enableEl(C))}}(),a});