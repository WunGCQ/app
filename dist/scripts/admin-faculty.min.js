require(["node","utils","tooltip","CONF","PersonStore","mask","toast","modal","io"],function(a,t,e,n,r,o,d,i,l){function s(){var a=new l({url:t.appendQueries(X,{_id:K._id}),type:"post",form:"#up-form",dataType:"json"});return a}function c(a){a=a||{},a._id&&k.attr("data-id",a._id),I.val(a.name),N.val(a.title),S.val(a.description),O.attr("src",a.avatar&&a.avatar.url||n.APP.defaultAvatar)}function u(){I.val(""),N.val(""),S.val(""),E.val(""),O.attr("src",n.APP.defaultAvatar),k.removeAttr("data-id")}function p(a,t){K=a,V=t}function f(t){var e=a("<div>"),r=a("<a>"),o=a("<a>"),d=a("<img>"),i=a("<h4>"),l=a("<h4>"),s=a("<i>"),c=a("<span>"),u=a("<p>");r.addClass("person-card__edit-btn fa fa-pencil"),o.addClass("person-card__delete-btn fa fa-trash"),d.attr("src",t.avatar&&t.avatar.url||n.APP.defaultAvatar),t.avatar&&t.avatar.url&&d.attr("src",t.avatar.url),d.addClass(U),i.addClass($),i.text(t.name),s.addClass("fa fa-flag person-card__meta-label"),c.addClass(M),c.text(t.title),l.addClass("person-card__meta"),l.append(s),l.append(c),u.addClass(q),u.text(t.description),e.addClass("person-card"),e.attr("data-id",t._id),e.append(r),e.append(o),e.append(d),e.append(i),e.append(l),e.append(u),T.prepend(e)}function v(a,t){t=t||V,console.log(a),t&&a&&a._id&&(t.one(B).attr("src",a.avatar&&a.avatar.url||n.APP.defaultAvatar),t.one(D).text(a.name),t.one(H).text(a.title),t.one(J).text(a.description))}function _(a){a=a||g(),K&&K._id&&(a._id=K._id),t.disableEl(x),W.saveOne(a).then(function(a){K=a,d.make("saving..");var t=E[0].files[0];return t?s(t):a}).then(function(a){console.log(a),K.avatar=a&&a.length>0?a[0]:{url:O.attr("src")},d.make("done"),t.enableEl(x),E.val(""),h().then(function(){d.make(),V&&k.attr("data-id")?v(K):f(K)})},function(a){console.log(a),t.enableEl(x),E.val("")})}function m(a){var t=a.attr("data-id");return console.log(t),W.deleteOne(t).then(function(t){d.make("deleted"),console.log(t),a.fadeOut(.4,function(){a.remove()})},function(){})}function g(){var a={_id:k.attr("data-id"),name:I.val(),title:N.val(),description:S.val(),avatar:{url:O.attr("src")}};return a}function w(a){var t={_id:a.attr("data-id"),name:a.one(D).text(),title:a.one(H).text(),description:a.one(J).text(),avatar:{url:a.one(B).attr("src")}};return console.log(t),t}function A(){return b.addClass("faculty-editor-wrapper--active"),i.open(b).then(function(){k.addClass("faculty-editor--up")})}function h(){return i.close().then(function(){k.removeClass("faculty-editor--up")})}var C=a(".add-person-btn"),b=a(".faculty-editor-wrapper"),k=a(".faculty-editor"),P=a(".modal__closer"),x=(a(".modal__cancel-btn"),a(".modal__confirm-btn")),y=a("#up-form"),O=a(".person__avatar-preview"),E=a(".person__avatar-selector"),L=a(".person__roles-setter"),I=a(".person__name-editor"),N=a(".person__title-editor"),S=a(".person__description-editor"),T=a(".person-gallery"),j=Ecpkn.LANG.actions.edit,F=Ecpkn.LANG.actions["delete"],G="person-card__edit-btn",R="person-card__delete-btn",U="person-card__avatar",$="person-card__name",q="person-card__description",M="person-card__title",Q="."+G,z="."+R,B="."+U,D="."+$,H="."+M,J="."+q,K=null,V=null,W=new r({saveOne:{url:n.API.person.root},deleteOne:{url:n.API.person.root}}),X=n.API.person.uploadAvatar;i.setConf({base:{"background-color":"transparent"}}),T.delegate("click",".person-card",function(t){var e=a(t.target),n=a(t.currentTarget);if(e.hasClass(G)){var r=w(n);p(r,n),c(r),A()}else if(e.hasClass(R)){var o=window.confirm("");o&&m(n)}}),C.on("click",function(){K=null,u(),A()}),P.on("click",h),x.on("click",function(){_()}),E.on("change",function(a){var t=E[0].files[0];O.attr("src",URL.createObjectURL(t))}),L.on("click",function(t){a(t.target)}),T.delegate("mouseover",Q,function(a){e.show(a.target,j)}),T.delegate("mouseover",z,function(a){e.show(a.target,F)}),T.delegate("mouseout",[Q,z],function(a){e.hide()}),e.init(),window.Mask=o,window.Toast=d,window.personStore=W,window.$editorAvatarForm=y,window.$personAvatarSelector=E});