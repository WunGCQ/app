require(["node","utils","tooltip","CONF","PersonStore","mask","toast","modal","io"],function(e,a,t,r,o,n,l,s,d){function c(){var e=new d({url:a.appendQueries(Z,{_id:W._id}),type:"post",form:"#up-form",dataType:"json"});return e}function i(e){console.log(e),e=e||{},e._id&&b.attr("data-id",e._id),I.val(e.name),N.val(e.title),S.val(e.description),j.all(".choice").each(function(a){-1!==e.roles.indexOf(a.attr("data-role"))&&a.addClass("choice--selected")}),E.attr("src",e.avatar&&e.avatar.url||r.APP.defaultAvatar)}function u(){I.val(""),N.val(""),S.val(""),L.val(""),E.attr("src",r.APP.defaultAvatar),b.removeAttr("data-id"),j.all(".choice").removeClass("choice--selected")}function p(e,a){W=e,X=a}function v(a){var t=e("<div>"),o=e("<a>"),n=e("<a>"),l=e("<img>"),s=e("<h4>"),d=e("<h4>"),c=e("<i>"),i=e("<span>"),u=e("<p>");o.addClass("person-card__edit-btn fa fa-pencil"),n.addClass("person-card__delete-btn fa fa-trash"),l.attr("src",a.avatar&&a.avatar.url||r.APP.defaultAvatar),a.avatar&&a.avatar.url&&l.attr("src",a.avatar.url),l.addClass(q),s.addClass(M),s.text(a.name),c.addClass("fa fa-flag person-card__meta-label"),i.addClass(z),i.text(a.title),d.addClass("person-card__meta"),d.append(c),d.append(i),u.addClass(Q),u.text(a.description),t.addClass("person-card"),t.attr("data-id",a._id),t.attr("data-roles",a.roles.join("|")),t.append(o),t.append(n),t.append(l),t.append(s),t.append(d),t.append(u),F.prepend(t)}function f(e,a){a=a||X,console.log(e),a&&e&&e._id&&(a.one(H).attr("src",e.avatar&&e.avatar.url||r.APP.defaultAvatar),a.one(J).text(e.name),a.one(K).text(e.title),a.one(V).text(e.description),a.attr("data-roles",e.roles.join("|")),Y.updateLocalOne(e))}function _(e){e=e||h(),W&&W._id&&(e._id=W._id),delete e.avatar,a.disableEl(O),Y.saveOne(e).then(function(e){console.log(e),W=e,l.make("saving..");var a=L[0].files[0];return a?c(a):e}).then(function(e){console.log(e),W.avatar=e&&e.length>0?e[0]:{url:E.attr("src")},l.make("done"),a.enableEl(O),console.log(W),L.val(""),w().then(function(){l.make(),X&&b.attr("data-id")?f(W):v(W)})},function(e){console.log(e),a.enableEl(O),L.val("")})}function m(e){var a=e.attr("data-id");return console.log(a),Y.deleteOne(a).then(function(a){l.make("deleted"),console.log(a),e.fadeOut(.4,function(){e.remove()})},function(){})}function h(){var e={_id:b.attr("data-id"),name:I.val(),title:N.val(),description:S.val(),avatar:{url:E.attr("src")},roles:[]};return j.all(".choice--selected").each(function(a){e.roles.push(a.attr("data-role"))}),e}function g(e){var a={_id:e.attr("data-id"),name:e.one(J).text(),title:e.one(K).text(),description:e.one(V).text(),avatar:{url:e.one(H).attr("src")},roles:e.attr("data-roles").split("|")};return console.log(a),a}function C(){return k.addClass("faculty-editor-wrapper--active"),s.open(k).then(function(){b.addClass("faculty-editor--up")})}function w(){return s.close().then(function(){b.removeClass("faculty-editor--up")})}var A=e(".add-person-btn"),k=e(".faculty-editor-wrapper"),b=e(".faculty-editor"),P=e(".modal__closer"),x=e(".modal__cancel-btn"),O=e(".modal__confirm-btn"),y=e("#up-form"),E=e(".person__avatar-preview"),L=e(".person__avatar-selector"),j=e(".person__roles-setter"),I=e(".person__name-editor"),N=e(".person__title-editor"),S=e(".person__description-editor"),T=e(".person-of-role-switcher"),F=e(".person-gallery"),G=Ecpkn.LANG.actions.edit,R=Ecpkn.LANG.actions["delete"],U="person-card__edit-btn",$="person-card__delete-btn",q="person-card__avatar",M="person-card__name",Q="person-card__description",z="person-card__title",B="."+U,D="."+$,H="."+q,J="."+M,K="."+z,V="."+Q,W=null,X=null,Y=new o({getOne:{url:r.API.person.root},saveOne:{url:r.API.person.root},deleteOne:{url:r.API.person.root}}),Z=r.API.person.uploadAvatar;s.setConf({base:{"background-color":"transparent"}}),F.delegate("click",".person-card",function(a){var t=e(a.target),r=e(a.currentTarget);if(t.hasClass(U)){var o=g(r);p(o,r),u(),i(o),C()}else if(t.hasClass($)){var n=window.confirm("");n&&m(r)}}),T.delegate("click",".btn",function(a){var t="person-gallery-",r=e(a.target),o=r.attr("data-active"),n=F.attr("data-filter");n?F.replaceClass(t+n,t+o):F.addClass(t+o),F.attr("data-filter",o),T.one(".active").removeClass("active"),r.addClass("active")}),A.on("click",function(){W=null,u(),C()}),P.on("click",w),O.on("click",function(){_()}),x.on("click",function(){h()}),L.on("change",function(e){var a=L[0].files[0];E.attr("src",URL.createObjectURL(a))}),j.delegate("click",".choice",function(a){var t=e(a.target);if(3===t.index())if(t.hasClass("choice--selected"))t.removeClass("choice--selected");else for(t.addClass("choice--selected");t=t.prev();)t.removeClass("choice--selected");else j.last().removeClass("choice--selected"),t.toggleClass("choice--selected")}),F.delegate("mouseover",B,function(e){t.show(e.target,G)}),F.delegate("mouseover",D,function(e){t.show(e.target,R)}),F.delegate("mouseout",[B,D],function(e){t.hide()}),t.init(),window.Mask=n,window.Toast=l,window.personStore=Y,window.$editorAvatarForm=y,window.$personAvatarSelector=L});