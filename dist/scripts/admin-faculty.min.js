require(["node","utils","tooltip","CONF","personAgent","mask","toast","modal","io"],function(a,e,t,n,r,o,d,l,i){function s(){var a=new i({url:e.appendQueries(W,{_id:J._id}),type:"post",form:"#up-form",dataType:"json"});return a}function c(a){a=a||{},a._id&&k.attr("data-id",a._id),L.val(a.name),I.val(a.role),N.val(a.description),O.attr("src",a.avatar&&a.avatar.url||n.APP.defaultAvatar)}function p(){L.val(""),I.val(""),N.val(""),E.val(""),O.attr("src",n.APP.defaultAvatar),k.removeAttr("data-id")}function u(a,e){J=a,K=e}function f(e){var t=a("<div>"),r=a("<a>"),o=a("<a>"),d=a("<img>"),l=a("<h4>"),i=a("<h4>"),s=a("<i>"),c=a("<span>"),p=a("<p>");r.addClass("person-card__edit-btn fa fa-pencil"),o.addClass("person-card__delete-btn fa fa-trash"),d.attr("src",e.avatar&&e.avatar.url||n.APP.defaultAvatar),e.avatar&&e.avatar.url&&d.attr("src",e.avatar.url),d.addClass(U),l.addClass($),l.text(e.name),s.addClass("fa fa-flag person-card__meta-label"),c.addClass(M),c.text(e.role),i.addClass("person-card__meta"),i.append(s),i.append(c),p.addClass(q),p.text(e.description),t.addClass("person-card"),t.attr("data-id",e._id),t.append(r),t.append(o),t.append(d),t.append(l),t.append(i),t.append(p),T.prepend(t)}function v(a,e){e=e||K,e&&a&&a._id&&(e.one(z).attr("src",a.avatar&&a.avatar.url||n.APP.defaultAvatar),e.one(B).text(a.name),e.one(D).text(a.role),e.one(H).text(a.description))}function _(a){a=a||g(),J&&J._id&&(a._id=J._id),e.disableEl(x),V.saveOne(a).then(function(a){J=a,d.make("first");var e=E[0].files[0];return e?s(e):a}).then(function(a){console.log(a);var t=a[0];J.avatar=t,d.make("done"),e.enableEl(x),E.val(""),C().then(function(){d.make(),K&&k.attr("data-id")?v(J):f(J)})},function(a){console.log(a),e.enableEl(x),E.val("")})}function m(a){var e=a.attr("data-id");return console.log(e),V.deleteOne(e).then(function(e){d.make("deleted"),console.log(e),a.fadeOut(.4,function(){a.remove()})},function(){})}function g(){var a={};return a.name=L.val(),a.role=I.val(),a.description=N.val(),a}function w(a){var e={_id:a.attr("data-id"),name:a.one(B).text(),role:a.one(D).text(),description:a.one(H).text(),avatar:{url:a.one(z).attr("src")}};return console.log(e),e}function A(){return b.addClass("faculty-editor-wrapper--active"),l.open(b).then(function(){k.addClass("faculty-editor--up")})}function C(){return l.close().then(function(){k.removeClass("faculty-editor--up")})}var h=a(".add-person-btn"),b=a(".faculty-editor-wrapper"),k=a(".faculty-editor"),P=a(".modal__closer"),x=(a(".modal__cancel-btn"),a(".modal__confirm-btn")),y=a("#up-form"),O=a(".person__avatar-preview"),E=a(".person__avatar-selector"),L=a(".person__name-editor"),I=a(".person__role-editor"),N=a(".person__description-editor"),T=a(".person-gallery"),j=Ecpkn.LANG.actions.edit,F=Ecpkn.LANG.actions["delete"],G="person-card__edit-btn",R="person-card__delete-btn",U="person-card__avatar",$="person-card__name",q="person-card__description",M="person-card__role",Q="."+G,S="."+R,z="."+U,B="."+$,D="."+M,H="."+q,J=null,K=null,V=new r({saveOne:{url:n.API.person.root},deleteOne:{url:n.API.person.root}}),W=n.API.person.uploadAvatar;l.setConf({base:{"background-color":"transparent"}}),T.delegate("click",".person-card",function(e){var t=a(e.target),n=a(e.currentTarget);if(t.hasClass(G)){var r=w(n);u(r,n),c(r),A()}else if(t.hasClass(R)){var o=window.confirm("");o&&m(n)}}),h.on("click",function(){J=null,p(),A()}),P.on("click",C),x.on("click",function(){_()}),E.on("change",function(a){var e=E[0].files[0];O.attr("src",URL.createObjectURL(e))}),T.delegate("mouseover",Q,function(a){t.show(a.target,j)}),T.delegate("mouseover",S,function(a){t.show(a.target,F)}),T.delegate("mouseout",[Q,S],function(a){t.hide()}),t.init(),window.Mask=o,window.Toast=d,window.personAgent=V,window.$editorAvatarForm=y,window.$personAvatarSelector=E});